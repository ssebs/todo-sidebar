(()=>{"use strict";var e={265(e,t,i){var n,s=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(n=function(e){return n=Object.getOwnPropertyNames||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[t.length]=i);return t},n(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=n(e),r=0;r<i.length;r++)"default"!==i[r]&&s(t,e,i[r]);return o(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.activate=function(e){console.log("Todo Sidebar extension is now active!"),l=new c.KanbanViewProvider(e),e.subscriptions.push(a.window.registerWebviewViewProvider(c.KanbanViewProvider.viewType,l));const t=a.commands.registerCommand("todoSidebar.openFile",async()=>{const e=await a.window.showOpenDialog({canSelectFiles:!0,canSelectFolders:!1,canSelectMany:!1,filters:{Markdown:["md"]},title:"Select a Markdown file for the Todo Board"});e&&e[0]&&(await l.setActiveFile(e[0]),a.window.showInformationMessage(`Loaded: ${e[0].fsPath}`))}),i=a.commands.registerCommand("todoSidebar.refresh",async()=>{await l.refresh()});e.subscriptions.push(t,i)},t.deactivate=function(){l&&l.dispose()};const a=r(i(398)),c=i(913);let l},337(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.parseMarkdown=function(e){const t=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n"),h={title:"",description:"",columns:[]};let d=null,f=[],u=!1;for(let e=0;e<t.length;e++){const p=t[e],g=e+1;if(!u){const e=p.match(i);if(e){h.title=e[1].trim();continue}const t=p.match(n);if(t){h.description?h.description+="\n"+t[1]:h.description=t[1];continue}}const v=p.match(s);if(v){u=!0;const e=v[1].trim();d={title:e,line:g,isDoneColumn:e.toLowerCase().includes("done"),tasks:[]},h.columns.push(d),f=[];continue}const w=p.match(o);if(w&&d){const e=w[1].length,t="x"===w[2].toLowerCase(),i={text:w[3].trim(),checked:t,line:g,children:[],hasCheckbox:!0};for(;f.length>0&&f[f.length-1].indent>=e;)f.pop();f.length>0?f[f.length-1].task.children.push(i):d.tasks.push(i),f.push({task:i,indent:e});continue}const _=p.match(r);if(_&&d){const e=_[1].length,t=_[2],i="☑"===t||"✓"===t,n={text:_[3].trim(),checked:i,line:g,children:[],hasCheckbox:!0};for(;f.length>0&&f[f.length-1].indent>=e;)f.pop();f.length>0?f[f.length-1].task.children.push(n):d.tasks.push(n),f.push({task:n,indent:e});continue}const m=p.match(a);if(m&&f.length>0){const e={text:m[2].trim(),checked:!1,line:g,children:[],hasCheckbox:!1};f[f.length-1].task.children.push(e);continue}const b=p.match(c);if(b&&f.length>0){const e=b[1].length,t=b[2].trim();if(t.match(l))continue;const i={text:t,checked:!1,line:g,children:[],hasCheckbox:!1};for(;f.length>1&&f[f.length-1].indent>=e;)f.pop();f.length>0&&f[f.length-1].task.children.push(i)}}return h};const i=/^#\s+([^#].*)$/,n=/^>\s*(.*)$/,s=/^##\s+(.+)$/,o=/^(\s*)[-*]\s+\[([ xX])\]\s+(.+)$/,r=/^(\s*)[-*]\s+([☐☑✓✗])\s+(.+)$/,a=/^(\s*)[-*]\s+>\s*(.+)$/,c=/^(\s+)[-*]\s+(.+)$/,l=/^\[[ xX]\]|^[☐☑✓✗]/},398(e){e.exports=require("vscode")},522(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.toggleTaskInContent=function(e,t,i){const{lines:a,lineEnding:c}=d(e),l=t-1;if(l>=0&&l<a.length){const e=a[l];if(i){let t=e.replace(n,"$1[x]");t=t.replace(o,"$1☑"),a[l]=t}else{let t=e.replace(s,"$1[ ]");t=t.replace(r,"$1☐"),a[l]=t}}return a.join(c)},t.moveTaskInContent=function(e,t,n,s="bottom",o){const{lines:r,lineEnding:a}=d(e),c=t-1,l=[],f=r[c]?.match(i)?.[1].length??0;l.push(r[c]);let u=c+1;for(;u<r.length;){const e=r[u],t=e.match(i)?.[1].length??0;if(""===e.trim())break;if(t<=f&&""!==e.trim())break;l.push(e),u++}const p=l.map(e=>e.startsWith(" ".repeat(f))?e.slice(f):e),g=[...r.slice(0,c),...r.slice(c+l.length)];let v=-1,w=o;void 0!==o&&t<o&&(w=o-l.length);for(let e=0;e<g.length;e++){const t=g[e].match(h);if(t){const o=t[1].trim();if(o===n||o.startsWith(n)){if("top"===s){let t=e+1;for(;t<g.length&&""===g[t].trim();)t++;v=t}else if("after"===s&&void 0!==w){const e=w-1;if(e>=0&&e<g.length){const t=g[e]?.match(i)?.[1].length??0;let n=e+1;for(;n<g.length;){const e=g[n],s=e.match(i)?.[1].length??0;if(""===e.trim()||s<=t)break;n++}v=n}}else{let t=e+1;for(;t<g.length&&!g[t].match(h);)t++;v=t}break}}}if(-1===v)return e;const _=[...g.slice(0,v),...p,"",...g.slice(v)],m=[];let b=!1;for(const e of _){const t=""===e.trim();t&&b||(m.push(e),b=t)}return m.join(a)},t.moveTaskToParent=function(e,t,n,s="bottom",o){const{lines:r,lineEnding:c}=d(e),l=t-1,h=n-1,f=r[l];if(!f)return e;const u=f.match(a);if(!u)return e;const p=u[1]||"[ ]",g=u[2],v=r[h];if(!v)return e;const w=v.match(i)?.[1].length??0,_=" ".repeat(w+2),m=[],b=f.match(i)?.[1].length??0;m.push(`${_}- ${p} ${g}`);let k=l+1;for(;k<r.length;){const e=r[k],t=e.match(i)?.[1].length??0;if(""===e.trim())break;if(t<=b&&""!==e.trim())break;const n=e.match(/^(\s*)(.+)$/);if(n){const e=" ".repeat(w+2+(t-b));m.push(`${e}${n[2]}`)}k++}const F=k-l;let y=h;l<h&&(y=h-F);const T=[...r.slice(0,l),...r.slice(l+F)];let x;const P=T[y],S=P?.match(i)?.[1].length??0;if("top"===s)x=y+1;else if("after"===s&&void 0!==o){let e=o;l<o&&(e=o-F);const t=e-1;if(t>=0&&t<T.length){const e=T[t]?.match(i)?.[1].length??0;for(x=t+1;x<T.length;){const t=T[x],n=t.match(i)?.[1].length??0;if(""===t.trim()||n<=e)break;x++}}else x=y+1}else for(x=y+1;x<T.length;){const e=T[x],t=e.match(i)?.[1].length??0;if(""===e.trim())break;if(t<=S)break;x++}const j=[...T.slice(0,x),...m,...T.slice(x)],C=[];let O=!1;for(const e of j){const t=""===e.trim();t&&O||(C.push(e),O=t)}return C.join(c)},t.addTaskToSection=function(e,t){const{lines:i,lineEnding:n}=d(e);let s=-1;for(let e=0;e<i.length;e++){const n=i[e].match(h);if(n&&n[1].trim()===t){s=e;break}}if(-1===s)return{content:e,line:-1};let o=s+1;for(;o<i.length&&""===i[o].trim();)o++;return i.splice(o,0,"- [ ] New task"),{content:i.join(n),line:o+1}},t.editTaskTextInContent=function(e,t,i){const{lines:n,lineEnding:s}=d(e),o=t-1;if(o<0||o>=n.length)return e;const r=n[o],a=r.match(c);if(a)return n[o]=a[1]+i,n.join(s);const h=r.match(l);return h?(n[o]=h[1]+i,n.join(s)):e},t.addSubtaskToParent=function(e,t){const{lines:n,lineEnding:s}=d(e),o=t-1;if(o<0||o>=n.length)return{content:e,line:-1};const r=n[o],a=r.match(i)?.[1].length??0,c=" ".repeat(a+2);let l=o+1;for(;l<n.length;){const e=n[l],t=e.match(i)?.[1].length??0;if(""===e.trim())break;if(t<=a)break;l++}const h=`${c}- [ ] New task`;return n.splice(l,0,h),{content:n.join(s),line:l+1}},t.removeCheckboxFromTask=function(e,t){const{lines:i,lineEnding:n}=d(e),s=t-1;if(s<0||s>=i.length)return e;const o=i[s],r=o.match(/^(\s*[-*]\s+)\[[ xX]\]\s+(.+)$/);if(r)return i[s]=r[1]+r[2],i.join(n);const a=o.match(/^(\s*[-*]\s+)[☐☑✓✗]\s+(.+)$/);return a?(i[s]=a[1]+a[2],i.join(n)):e};const i=/^(\s*)/,n=/([-*]\s+)\[ \]/,s=/([-*]\s+)\[[xX]\]/,o=/([-*]\s+)☐/,r=/([-*]\s+)[☑✓]/,a=/^\s*[-*]\s+(\[[ xX]\]|[☐☑✓✗])?\s*(.+)$/,c=/^(\s*[-*]\s+\[[ xX]\]\s+)(.+)$/,l=/^(\s*[-*]\s+[☐☑✓✗]\s+)(.+)$/,h=/^##\s+(.+)$/;function d(e){const t=e.includes("\r\n")?"\r\n":"\n";return{lines:e.split(/\r?\n/),lineEnding:t}}},896(e){e.exports=require("fs")},913(e,t,i){var n,s=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(n=function(e){return n=Object.getOwnPropertyNames||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[t.length]=i);return t},n(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=n(e),r=0;r<i.length;r++)"default"!==i[r]&&s(t,e,i[r]);return o(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.KanbanViewProvider=void 0;const a=r(i(398)),c=r(i(928)),l=r(i(896)),h=i(337),d=i(522);t.KanbanViewProvider=class{_context;static viewType="todoSidebar.kanbanView";_view;_activeFileUri;_board;_disposables=[];_pendingEditLine;constructor(e){this._context=e}resolveWebviewView(e,t,i){this._view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this._context.extensionUri]},e.webview.html=this._getHtmlForWebview(e.webview),e.onDidChangeVisibility(()=>{e.visible&&this._activeFileUri&&this._refresh()}),e.webview.onDidReceiveMessage(async e=>{switch(e.type){case"toggle":await this._handleToggle(e.line,e.checked,e.targetColumn);break;case"move":await this._handleMove(e.taskLine,e.targetSection,e.position,e.afterLine);break;case"openAtLine":await this._handleOpenAtLine(e.line);break;case"getColumns":this._board&&this._view?.webview.postMessage({type:"columnsForPicker",columns:this._board.columns.map(e=>({title:e.title,isDoneColumn:e.isDoneColumn})),taskLine:e.line});break;case"moveToParent":await this._handleMoveToParent(e.taskLine,e.parentLine,e.position,e.afterLine);break;case"addTask":await this._handleAddTask(e.section);break;case"editTaskText":await this._handleEditTaskText(e.line,e.newText);break;case"addSubtask":await this._handleAddSubtask(e.parentLine)}}),0===this._disposables.length&&this._setupFileWatchers();const n=a.workspace.getConfiguration("todoSidebar").get("activeFile");if(console.log("Attempting to restore activeFile from settings:",n),n)try{this._activeFileUri=a.Uri.file(n),console.log("Restored activeFile:",this._activeFileUri.fsPath)}catch(e){console.error("Failed to restore saved file:",e)}this._activeFileUri&&this._refresh()}_setupFileWatchers(){this._disposables.push(a.workspace.onDidChangeTextDocument(e=>{this._activeFileUri&&e.document.uri.toString()===this._activeFileUri.toString()&&this._refresh()}));const e=a.workspace.createFileSystemWatcher("**/*.md");this._disposables.push(e.onDidChange(e=>{this._activeFileUri&&e.toString()===this._activeFileUri.toString()&&this._refresh()})),this._disposables.push(e)}async setActiveFile(e){this._activeFileUri=e;try{if(!(a.workspace.workspaceFolders&&a.workspace.workspaceFolders.length>0))return console.error("No workspace folder open - cannot save to workspace settings"),a.window.showWarningMessage("Please open a folder/workspace to persist the todo file selection"),void await this._refresh();const t=a.workspace.workspaceFolders[0],i=a.Uri.joinPath(t.uri,".vscode"),n=a.Uri.joinPath(i,"settings.json");try{await a.workspace.fs.stat(i)}catch{await a.workspace.fs.createDirectory(i),console.log("Created .vscode directory")}let s={},o="";try{const e=await a.workspace.fs.readFile(n);o=Buffer.from(e).toString("utf-8");const t=o.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,"");s=JSON.parse(t)}catch(e){console.log("Creating new settings.json file (or couldn't parse existing)")}s["todoSidebar.activeFile"]=e.fsPath;const r=JSON.stringify(s,null,4);await a.workspace.fs.writeFile(n,Buffer.from(r,"utf-8")),console.log("Saved activeFile to .vscode/settings.json:",e.fsPath)}catch(e){console.error("Failed to save activeFile to settings:",e),a.window.showErrorMessage(`Failed to save todo file selection: ${e}`)}await this._refresh()}async refresh(){await this._refresh()}async _readActiveFile(){if(!this._activeFileUri)return"";const e=await a.workspace.fs.readFile(this._activeFileUri);return Buffer.from(e).toString("utf-8")}async _writeActiveFile(e){this._activeFileUri&&await a.workspace.fs.writeFile(this._activeFileUri,Buffer.from(e,"utf-8"))}async _refresh(){if(this._activeFileUri&&this._view)try{const e=await this._readActiveFile();this._board=(0,h.parseMarkdown)(e);const t=this._pendingEditLine;this._pendingEditLine=void 0,this._view.webview.postMessage({type:"update",board:this._board,editLine:t})}catch(e){console.error("Error refreshing kanban board:",e)}}async _handleToggle(e,t,i){if(this._activeFileUri&&this._board)try{let n=await this._readActiveFile();n=(0,d.toggleTaskInContent)(n,e,t);const s=this._isTopLevelTask(e);if(t&&s){const t=this._board.columns.find(e=>e.isDoneColumn);if(t){const i=this._findTaskColumn(e);i&&!i.isDoneColumn&&(n=(0,d.moveTaskInContent)(n,e,t.title,"top"))}}else i&&s&&(n=(0,d.moveTaskInContent)(n,e,i,"top"));await this._writeActiveFile(n)}catch(e){console.error("Error toggling task:",e)}}_isTopLevelTask(e){if(!this._board)return!1;for(const t of this._board.columns)for(const i of t.tasks)if(i.line===e)return!0;return!1}_findTaskColumn(e){if(!this._board)return;const t=i=>{for(const n of i){if(n.line===e)return!0;if(t(n.children))return!0}return!1};for(const e of this._board.columns)if(t(e.tasks))return e}async _handleMove(e,t,i="bottom",n){if(this._activeFileUri)try{let s=await this._readActiveFile();s=(0,d.moveTaskInContent)(s,e,t,i,n),await this._writeActiveFile(s)}catch(e){console.error("Error moving task:",e)}}async _handleMoveToParent(e,t,i="bottom",n){if(this._activeFileUri)try{let s=await this._readActiveFile();s=(0,d.moveTaskToParent)(s,e,t,i,n),await this._writeActiveFile(s)}catch(e){console.error("Error moving task to parent:",e)}}async _handleOpenAtLine(e){if(this._activeFileUri)try{const t=await a.workspace.openTextDocument(this._activeFileUri),i=await a.window.showTextDocument(t),n=new a.Position(e-1,0);i.selection=new a.Selection(n,n),i.revealRange(new a.Range(n,n),a.TextEditorRevealType.InCenter)}catch(e){console.error("Error opening file at line:",e)}}async _handleAddTask(e){if(this._activeFileUri)try{const t=await this._readActiveFile(),i=(0,d.addTaskToSection)(t,e);i.line>0&&(this._pendingEditLine=i.line,await this._writeActiveFile(i.content))}catch(e){console.error("Error adding task:",e)}}async _handleEditTaskText(e,t){if(this._activeFileUri)try{let i=await this._readActiveFile();i=(0,d.editTaskTextInContent)(i,e,t),await this._writeActiveFile(i)}catch(e){console.error("Error editing task text:",e)}}async _handleAddSubtask(e){if(this._activeFileUri)try{const t=await this._readActiveFile(),i=(0,d.addSubtaskToParent)(t,e);i.line>0&&(this._pendingEditLine=i.line,await this._writeActiveFile(i.content))}catch(e){console.error("Error adding subtask:",e)}}_getHtmlForWebview(e){const t=function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let i=0;i<32;i++)e+=t.charAt(Math.floor(62*Math.random()));return e}(),i=c.join(this._context.extensionPath,"src","webview.html");let n=l.readFileSync(i,"utf-8");return n=n.replace(/\{\{cspSource\}\}/g,e.cspSource),n=n.replace(/\{\{nonce\}\}/g,t),n}dispose(){for(const e of this._disposables)e.dispose()}}},928(e){e.exports=require("path")}},t={},i=function i(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,i),o.exports}(265);module.exports=i})();